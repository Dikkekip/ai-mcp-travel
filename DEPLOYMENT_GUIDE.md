# Deployment Guide: MCP Server to Azure Container Apps

This guide will help you deploy the MCP server to Azure Container Apps using Azure Developer CLI (azd).

## Prerequisites

âœ… Azure Developer CLI (azd) is installed
- You may need to restart your terminal/VS Code for the installation to take effect

You'll also need:
- An Azure subscription
- An active Azure account

## Step-by-Step Deployment

### Step 1: Authenticate with Azure

Open a new terminal (to ensure azd is available) and run:

```powershell
azd auth login --use-device-code
```

This will open your browser and prompt you to authenticate. You'll also need to enter a device code shown in the terminal.

### Step 2: Initialize the Project (First Time Only)

If this is your first deployment, you may need to initialize the project:

```powershell
azd init
```

This will set up your Azure environment.

### Step 3: Generate JWT Token and Load Environment Variables

The deployment requires JWT authentication tokens. Generate and load them:

**Windows (PowerShell):**
```powershell
# Run the setup script to generate tokens and load them into azd
.\setup-azd-env.ps1
```

**Mac/Linux:**
```bash
chmod +x setup-azd-env.sh
./setup-azd-env.sh
```

This will:
1. Generate JWT tokens if `.env` doesn't exist
2. Load all variables from `.env` into azd environment
3. Set them so `azd up` won't prompt for values

> **Note:** You can also add `SERPAPI_KEY` and `WEATHERSTACK_API_KEY` to `.env` before running the setup script to enable travel assistant features.

### Step 4: Deploy to Azure

Run the following command to provision and deploy:

```powershell
azd up
```

This command will:
1. Create the Azure resources (Container Registry, Container App Environment, Container App)
2. Build and push your Docker image to Azure Container Registry
3. Deploy the container to Azure Container Apps
4. Configure all necessary environment variables and secrets

### Step 5: Get Your Deployment URL

After deployment completes, you'll see output like:

```
Endpoint: https://mcp-container-ts-xxxxxx.<region>.azurecontainerapps.io
```

Or you can retrieve it manually:

```powershell
azd show
```

This displays all the outputs including the endpoint URL.

### Step 6: Access Your MCP Server

Your MCP server will be available at:
```
https://<your-environment-name>.<container-id>.<region>.azurecontainerapps.io/mcp
```

## Important Notes

### Environment Variables

The deployment requires the following environment variables (which are generated by `npm run generate-token`):

- `JWT_TOKEN` - Bearer token for authentication
- `JWT_SECRET` - Secret for JWT signing
- `JWT_AUDIENCE` - JWT audience
- `JWT_ISSUER` - JWT issuer
- `JWT_EXPIRY` - Token expiry time

### Optional: Travel Assistant API Keys

If you want to use the travel assistant tools, you need these additional environment variables:

- `SERPAPI_KEY` - Required for flights, hotels, events, and finance servers
- `WEATHERSTACK_API_KEY` - Optional, for WeatherStack weather lookups

To add these to your deployment, you can:

1. Manually add them to the Container App in Azure Portal, or
2. Update the `infra/resources.bicep` file to include them in the secrets/environment variables

### Accessing the Container App

After deployment, you can:

1. **Use the endpoint URL** directly in your MCP clients
2. **Get the JWT token** from your `.env` file (or from Azure Key Vault/App Configuration if you've configured it)
3. **Configure your MCP client** with:
   - URL: `https://<your-app>.<region>.azurecontainerapps.io/mcp`
   - Headers: `Authorization: Bearer <your-jwt-token>`

## Cleanup

To remove all deployed resources and avoid charges:

```powershell
azd down --purge --force
```

## Troubleshooting

### Check Deployment Status

```powershell
azd monitor
```

### View Container Logs

```powershell
az containerapp logs show --name mcp-container-ts --resource-group <your-resource-group>
```

### Re-deploy After Code Changes

```powershell
azd deploy
```

This rebuilds and redeploys without provisioning new infrastructure.

## Additional Resources

- [Azure Container Apps Documentation](https://learn.microsoft.com/azure/container-apps/)
- [Azure Developer CLI Documentation](https://learn.microsoft.com/azure/developer/azure-developer-cli/)
- [Model Context Protocol](https://modelcontextprotocol.io/)

